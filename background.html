<html>
  <head>
    <script>
      chrome.browserAction.onClicked.addListener(function (t) {
          chrome.tabs.create(
            {"url" : "http://www.google.com/buzz/post?url=" + encodeURI(t.url) });
            
            setTimeout(getNewInfo(t.id), 5000); // Refresh the count.
      });
      
      chrome.tabs.onSelectionChanged.addListener(getNewInfo);
      chrome.tabs.onUpdated.addListener(getNewInfo);
      
      // Set up the context menus
      chrome.contextMenus.create({
        "title": "Buzz This",
        "contexts": ["page", "selection", "image", "link"],
        "onclick" : function(e) {
          var url = e.pageUrl;
          var buzzPostUrl = "http://www.google.com/buzz/post?";
          
          if (e.selectionText) {
            // The user selected some text, put this in the message.
            buzzPostUrl += "message=" + encodeURI(e.selectionText) + "&";
          }
          
          if (e.mediaType === "image") {
            buzzPostUrl += "imageurl=" + encodeURI(e.srcUrl) + "&";
          }
          
          if (e.linkUrl) {
            // The user wants to buzz a link.
            url = e.linkUrl;
          }
          
          buzzPostUrl += "url=" + encodeURI(url);
          
          // Open the page up.
           chrome.tabs.create(
              {"url" : buzzPostUrl });
        }
      });
      
      function getNewInfo(t, info) {
        chrome.tabs.get(t, function(tab) { 
          var url = "http://www.google.com/buzz/api/buzzThis/buzzCounter?url=" + encodeURI(tab.url);
          
          var xhr = new XMLHttpRequest();
          xhr.onreadystatechange = function() {
            if(xhr.readyState == 4 && xhr.status == 200) {
              var response = xhr.responseText;
              var matches = /google_buzz_set_count\((.+?)\);/;
              var results = response.match(matches);
              if(results) {
                var count = google_buzz_set_count(tab, JSON.parse(results[1]));
              }
            }
          }; 
          xhr.open("GET", url);
          xhr.send();
        });
      }
      
      function google_buzz_set_count(tab, data) {
        if(data[tab.url] != undefined && data[tab.url] != "undefined") {
          chrome.browserAction.setBadgeText({ "text" : data[tab.url] + "", "tabId" :tab.id });
        }
      }
    </script>
  </head>
</html>